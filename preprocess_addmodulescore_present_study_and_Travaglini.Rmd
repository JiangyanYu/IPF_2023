---
title: "ILD project seurat analysis"
author: "Jiangyan Yu (jiangyan.yu@uni-bonn.de)"
date: "`r Sys.Date()`"
output:
  html_document: 
    code_folding: hide
    number_sections: yes
    theme: united
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

notes: 
1) using addmodulescore function to compare the annotation from present study to Travaglini et al.
2) script is executed in docker: docker run â€“rm -p 8888:8787 -e USER=jyu -e PASSWORD=jyu -e ROOT=TRUE -v /home/agschlitzer/sciebo/Projects/IPF_ownerJY:/home/jyu/rstudio jiangyanyu/jyu_r4.1.2:1.0
3) report generated by: Rscript -e "rmarkdown::render('integrate_persent_study_with_Bassler_control.Rmd')"

# general steps

```{r global_options}
knitr::opts_chunk$set(warning=FALSE, messgae=FALSE, fig.path='Figs/', results = "hide")
## fig.width=4, fig.height=4
```

## load library

```{r include=FALSE}
rm(list=ls())
gc()
#CRAN packages
list.of.packages <- c("readr",
                      "cowplot",
                      "useful",
                      "stringr",
                      "umap",
                      "ggplot2",
                      "reshape2",
                      "dplyr",
                      "tidyr",
                      "Matrix.utils",
                      "VGAM",
                      "plotly",
                      "future",
                      "data.table"
)

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)>0) install.packages(new.packages)

#BioconductoR packages
list.of.bioc.packages <- c("tximport",
                           "DESeq2",
                           "Seurat",
                           "slingshot",
                           "flowCore",
                           "biomaRt",
                           "clusterProfiler",
                           "org.Hs.eg.db",
                           "GSEABase",
                           "DOSE",
                           "BiocGenerics",
                           "DelayedArray",
                           "DelayedMatrixStats",
                           "limma",
                           "S4Vectors",
                           "SingleCellExperiment",
                           "SummarizedExperiment",
                           "batchelor")
# "annotables")
new.packages.bioc <- list.of.bioc.packages[!(list.of.bioc.packages %in% installed.packages()[,"Package"])]
# 
if(length(new.packages.bioc)>0)if (!requireNamespace("BiocManager")) install.packages("BiocManager")
BiocManager::install(new.packages.bioc, update = FALSE)

lapply(c(list.of.packages,list.of.bioc.packages), require, character.only = TRUE)
```

## parallel computing

multicore does not work in rstudio. better to use plan::multiprocess

```{r include=FALSE}

# library(parallel)
# plan("multiprocess", workers = detectCores()-1)
# options(future.globals.maxSize = 20000 * 1024^2)
```
## working directory

```{r}
working.dir = "/home/jyu/rstudio/"
```

# upload IPF objects

```{r}
ipf_seu = readRDS(file=paste0(working.dir,"/IPF_manuscript/data/ILD_combined_sct_rpca20230720.rds"))
```

# annotate with Travaglini

tableS4, SS2 means smart-seq2 sequencing

use 10x clusters for cross-check

```{r}
tmp_sheet = readxl::excel_sheets(path = paste0(working.dir,"/IPF_manuscript/meta_data/Travaglini_41586_2020_2922_MOESM6_ESM.xlsx"))
tmp_type = data.frame("cluster" = NA,"name"=NA, "sheet" =NA)

tmp_seurat = ipf_seu

for(i in c(1:length(tmp_sheet))){
  travaglini_deg = readxl::read_xlsx(path = paste0(working.dir,"/IPF_manuscript/meta_data/Travaglini_41586_2020_2922_MOESM6_ESM.xlsx"),
                             sheet = tmp_sheet[i],col_names = FALSE)
  tmp_type[i,1] = i
  tmp_type[i,2] = travaglini_deg[1,1]
  tmp_type[i,3] = tmp_sheet[i]
  
  if(!tmp_sheet[i] %like% "SS2" ){
    colnames(travaglini_deg) = travaglini_deg[2,]
    travaglini_deg = travaglini_deg[c(3:nrow(travaglini_deg)),]
    travaglini_deg$avg_logFC = as.numeric(travaglini_deg$avg_logFC)
    travaglini_deg = subset(travaglini_deg,avg_logFC>1)
    
      tmp_seurat = AddModuleScore(object = tmp_seurat,
                               features = list(travaglini_deg$Gene),
                               ctrl = 5,
                               assay = "RNA",
                               name = paste0("travaglini",tmp_type[i,2])
                               )
    
  }else if(tmp_sheet[i] == "Cluster 43 (SS2)"){
    colnames(travaglini_deg) = travaglini_deg[2,]
    travaglini_deg = travaglini_deg[c(3:nrow(travaglini_deg)),]
    travaglini_deg$avg_logFC = as.numeric(travaglini_deg$avg_logFC)
    travaglini_deg = subset(travaglini_deg,avg_logFC>1)
    
      tmp_seurat = AddModuleScore(object = tmp_seurat,
                               features = list(travaglini_deg$Gene),
                               ctrl = 5,
                               assay = "RNA",
                               name = paste0("travaglini",tmp_type[i,2])
                               )
  }

}

write.csv(tmp_seurat@meta.data,file=paste0(working.dir,"/IPF_manuscript/meta_data/travaglini_clusters_prediction_score.csv"))


rm(tmp_sheet,tmp_type,i,travaglini_deg)
```

### heatmap

prediction score is from addmodulescore

```{r,fig.width=8,fig.height=12}
# travaglini_prediction = read.csv(file=paste0(working.dir,"travaglini_clusters_prediction_score.csv"))
travaglini_prediction = tmp_seurat@meta.data
tmp_prediction = colnames(travaglini_prediction)[colnames(travaglini_prediction) %like% "travaglini"]

tmp_data = cbind(travaglini_prediction$subcluster,travaglini_prediction[,c(tmp_prediction)])


colnames(tmp_data)[1] = "seurat_clusters"
# tmp_data$seurat_clusters = paste0("cluster",tmp_data$seurat_clusters)

tmp_data = tmp_data%>%
  group_by(seurat_clusters)%>% 
  summarise(across(tmp_prediction, mean)) %>% 
  as.data.frame()
rownames(tmp_data) = tmp_data$seurat_clusters
tmp_data = tmp_data[,-1]

colnames(tmp_data) = str_replace(colnames(tmp_data),pattern = "travaglini","")
colnames(tmp_data) = str_replace_all(colnames(tmp_data),pattern = "\\."," ")
colnames(tmp_data) = str_sub(colnames(tmp_data), 1, str_length(colnames(tmp_data))-1)


tmp_data = tmp_data[c("6","10","8","11","7","13","20","4_1","4_2","4_0","17","19","22","21","12","5", "9","14","15", "16", "24"),
                    c("Macrophage","Intermediate Monocyte","Myeloid Dendritic Type 1","Plasmacytoid Dendritic","Basophil Mast 1","Neutrophil","CD4  Naive T","Natural Killer T","Goblet","Ciliated" ,"Alveolar Epithelial Type 2" )]
# 
# tmp_data = tmp_data[c("6:S100A11+Mac","10:TNFAIP6+Mac","8:CXCL10+Mac","11:NEAT1+Mac","7:MKI67+Mac","13:MKI67+Mac","20:MKI67+Mac","4_1:RNASE1+Mac","4_2:SPP1+Mac","4_0:VCAN+Mac","25:Monocyte","17:DC","19:pDC","22:Eosinophil","21:Mast","12:Neutrophil","5:Tcell", "9:Tcell","14:NK","15:Goblet", "16:Ciliated", "24:Epithelial"),
#                     c("Macrophage","Intermediate Monocyte","Myeloid Dendritic Type 1","Plasmacytoid Dendritic","Basophil Mast 1","Neutrophil","CD4  Naive T","Natural Killer T","Goblet","Ciliated" ,"Alveolar Epithelial Type 2" )]

rownames(tmp_data) = c(paste0("S100A11+M","\u03c6","(6)"),paste0("TNFAIP6+M","\u03c6","(10)"),paste0("CXCL10+M","\u03c6","(8)"),paste0("NEAT1+M","\u03c6","(11)"),paste0("MKI67+M","\u03c6","(7)"),paste0("MKI67+M","\u03c6","(13)"),paste0("MKI67+M","\u03c6","(20)"),paste0("RNASE1+M","\u03c6","(4_1)"),paste0("SPP1+M","\u03c6","(4_2)"),paste0("VCAN+M","\u03c6","(4_0)"),"DC(17)","pDC(19)","Eosinophil(22)","Mast cell(21)","Neutrophil(12)","T cell(5)","T cell(9)","NK cell(14)","Goblet cell(15)","Ciliated cell(16)","Epithelial cell(24)")

colnames(tmp_data) = c("Macrophage","Intermediate monocyte","Myeloid dendritic type 1","Plasmacytoid dendritic cell","Basophil/Mast cell","Neutrophil","CD4+ naive T cell","Natural killer T cell","Goblet cell","Ciliated cell" ,"Alveolar epithelial type 2")

# grDevices::cairo_pdf(file = paste0(ms_dir,"figs1.singleliver.travaglini_",ms_date,".pdf"),width = 5,height =8)

col_fun = circlize::colorRamp2(c(-4, 0, 4), c("#a8dadc","white","#9d0208"))

ht1 = ComplexHeatmap::Heatmap(scale(tmp_data),
                        name = "Scaled prediction score",
                        col = col_fun,
                        cluster_rows = FALSE,
                        cluster_columns = FALSE,
                        row_names_side = "left",
                        column_names_side = "top",
                        row_title = "Clusters from present study",
                        column_title = "Clusters from Travaglini et al",
                        heatmap_legend_param = list(color_bar = "continuous", legend_direction = "horizontal",
                                                    legend_width = unit(4, "cm"))
                        )
ComplexHeatmap::draw(ht1, heatmap_legend_side = "bottom")

# dev.off()
rm(tmp_prediction,tmp_data,col_fun,ht1,travaglini_prediction)
```

# session info

```{r}
sessionInfo()
```

